name: Sync Postman Collections

on:
  push:
    branches: [ main ]
    paths:
      - 'collections/**'
      - 'environments/**'

jobs:
  sync-postman:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install -g newman
        
    - name: Sync User Service Collection
      env:
        POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        POSTMAN_USER_COLLECTION_ID: ${{ secrets.POSTMAN_USER_COLLECTION_ID }}
      run: |
        echo "üîÑ Starting User Service Collection sync..."
        echo "API Key: ${POSTMAN_API_KEY:0:10}..."
        echo "Collection ID: $POSTMAN_USER_COLLECTION_ID"
        
        if [ -f "collections/SmartDrive-User-Service-Collection.json" ]; then
          echo "üìÅ Collection file found, updating..."
          # Create the proper request body
          echo "{\"collection\": $(cat collections/SmartDrive-User-Service-Collection.json)}" > temp_request.json
          echo "üìÑ Request body preview (first 200 chars):"
          head -c 200 temp_request.json
          echo "..."
          
          response=$(curl -s -w "%{http_code}" -X PUT \
            -H "X-API-Key: $POSTMAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d @temp_request.json \
            "https://api.getpostman.com/collections/$POSTMAN_USER_COLLECTION_ID")
          
          http_code="${response: -3}"
          body="${response%???}"
          
          echo "Response Code: $http_code"
          echo "Response Body: $body"
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ User Service Collection updated successfully!"
          else
            echo "‚ùå Failed to update collection. HTTP Code: $http_code"
            exit 1
          fi
        else
          echo "‚ùå Collection file not found!"
          exit 1
        fi
        

        
    - name: Notify Success
      if: success()
      run: |
        echo "‚úÖ All Postman collections synced successfully!"
        echo "Updated at: $(date)"
        echo "Collections updated:"
        ls -la collections/*.json 2>/dev/null || echo "No collections found"
        
    - name: Notify Failure
      if: failure()
      run: |
        echo "‚ùå Failed to sync Postman collections"
        echo "Check the logs above for details"
